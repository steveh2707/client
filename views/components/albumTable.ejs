<div class="input-group mb-3">
  <span class="input-group-text" id="basic-addon1">
    <i class="bi bi-search"></i>
  </span>
  <input type="text" class="form-control" id="albumSearch" onkeyup="searchTable()"
    placeholder="Filter by album name, artist, release year, record label or genre...">
</div>
<table class="table table-dark align-middle" id="albumTable">
  <thead>
    <tr>
      <th scope="col" class="text-center">#</th>
      <th scope="col" class="text-center"></th>
      <th scope="col">
        <i class="bi bi-arrow-down-up"></i>
        Album Name
      </th>
      <th scope="col">
        <i class="bi bi-arrow-down-up"></i>
        Artist
      </th>
      <th scope="col" class="text-center">
        <i class="bi bi-arrow-down-up"></i>
        Release Year
      </th>
      <th scope="col" class="text-center">
        <i class="bi bi-arrow-down-up"></i>
        Record Label
      </th>
      <th scope="col" class="text-center">
        <i class="bi bi-arrow-down-up"></i>
        Genre
      </th>
      <th scope="col" class="text-center">

      </th>
    </tr>
  </thead>

  <tbody>

    <% data.forEach(album=> { %>

    <tr>

      <th id="num" scope="row" class="text-center"><%= album.album_id %></th>

      <td class="imageholder">
        <a href="/albums/<%= album.album_id %>" draggable='false'>
          <img class="image" src=<%=album.cover_image_url %>>
        </a>
      </td>
      <td>
        <a class="link-none" href="/albums/<%= album.album_id %>" draggable='false'><%= album.album_name %></a>
      </td>
      <td>
        <% album.albumArtists.forEach(artist=> { %>
        <a class="link-none" href="/artists/<%= artist.artist_id %>" draggable='false'>
          <%= artist.artist_name %>
        </a>
        <% }) %>
      </td>
      <td class="text-center"><%= album.release_year %></td>
      <td class="text-center"><%= album.record_label_name %></td>
      <td class="text-center"><%= album.genre_name %></td>
      <td class="text-center">

        <div class="dropdown">
          <button class="btn btn-secondary" type="button" data-bs-toggle="dropdown" aria-expanded="false"
            data-bs-auto-close="outside">
            <i class="bi bi-list"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li>
              <!-- <button class="dropdown-item text-center" type="button">See Album</button> -->
              <a class="dropdown-item text-center" href="/albums/<%= album.album_id %>" type="button">See Album</a>
            </li>
            <li>
              <a class="dropdown-item text-center" href="/artists/<%= album.albumArtists[0].artist_id %>"
                type="button">See Artist</a>
            </li>
            <div class="btn-group dropstart">
              <button type="button" class="dropdown-item dropdown-toggle text-center" data-bs-toggle="dropdown"
                aria-expanded="false">
                Add to Collection
              </button>
              <ul class="dropdown-menu">
                <% if (sess_valid && user.user_collections) { %>

                <% user.user_collections.forEach(collection => { %>
                <li>
                  <form method="POST" class="needs-validation" id="send" action="/addAlbumToCollection">
                    <input type="hidden" id="collectionID" name="collectionID" value=<%= collection.collection_id %>>
                    <input type="hidden" id="albumID" name="albumID" value=<%= album.album_id %>>
                    <button class="dropdown-item text-center" type="submit">
                      <%= collection.collection_name %>
                    </button>
                  </form>
                </li>
                <% }) %>

                <% } else if(sess_valid) { %>
                <li>
                  <a class="dropdown-item text-center" href="/addcollection" type="button">New Collection</a>
                </li>

                <% } else { %>
                <li>
                  <a class="dropdown-item text-center" href="/login" type="button">Please Login</a>
                </li>
                <% } %>
              </ul>
            </div>
          </ul>
        </div>



      </td>
    </tr>

    <% }) %>

  </tbody>

</table>


<script>

  function searchTable() {
    // Declare variables
    let input, filter, table, tr, td, i, txtValue
    let searchVals = []
    input = document.getElementById("albumSearch");
    filter = input.value.toUpperCase();
    table = document.getElementById("albumTable");
    tr = table.getElementsByTagName("tr");

    // Loop through all table rows, and hide those who don't match the search query
    for (i = 0; i < tr.length; i++) {
      tdAlbum = tr[i].getElementsByTagName("td")[1];
      tdArtist = tr[i].getElementsByTagName("td")[2];
      tdYear = tr[i].getElementsByTagName("td")[3];
      tdRecord = tr[i].getElementsByTagName("td")[4];
      tdGenre = tr[i].getElementsByTagName("td")[5];

      if (tdAlbum) {
        searchVals[0] = tdAlbum.innerText.toUpperCase().indexOf(filter)
        searchVals[1] = tdArtist.innerText.toUpperCase().indexOf(filter)
        searchVals[2] = tdYear.innerText.toUpperCase().indexOf(filter)
        searchVals[3] = tdRecord.innerText.toUpperCase().indexOf(filter)
        searchVals[4] = tdGenre.innerText.toUpperCase().indexOf(filter)

        if (searchVals.some(val => val > -1)) {
          tr[i].style.display = "";
        } else {
          tr[i].style.display = "none";
        }
      }
    }
  }

  var getCellValue = function (tr, idx) { return tr.children[idx].innerText || tr.children[idx].textContent; }

  var comparer = function (idx, asc) {
    return function (a, b) {
      return function (v1, v2) {
        return v1 !== '' && v2 !== '' && !isNaN(v1) && !isNaN(v2) ? v1 - v2 : v1.toString().localeCompare(v2);
      }(getCellValue(asc ? a : b, idx), getCellValue(asc ? b : a, idx));
    }
  };

  // do the work...
  Array.prototype.slice.call(
    document.querySelectorAll('th').forEach(th => th.addEventListener('click', (() => {
      const table = th.closest('table');
      const tbody = table.querySelector('tbody');
      Array.from(tbody.querySelectorAll('tr'))
        .sort(comparer(Array.from(th.parentNode.children).indexOf(th), this.asc = !this.asc))
        .forEach(tr => tbody.appendChild(tr))
    })))
  )



</script>